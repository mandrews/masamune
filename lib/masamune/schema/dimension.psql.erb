<% dimension.references.each do |name, dimension| %>
<%= dimension %>
<%- end -%>

CREATE TABLE IF NOT EXISTS <%= dimension.table_name %>
(
  <%- dimension.columns.each_with_index do |(name, column), i|
  last_column = dimension.unique_columns.any? ? false : (i >= dimension.columns.length - 1)
  -%>
  <%= column %><%= ',' unless last_column %>
  <%- end -%>
  <%- if dimension.unique_columns.any? -%>
  UNIQUE(<%= dimension.unique_columns.keys.join(', ') %>)
  <%- end -%>
);

<%
dimension.values.each do |record|
  unique_values = record.slice(*dimension.unique_columns.keys)
  next if unique_values.empty?
  unique_constraints = unique_values.map { |key, value| "#{key} = '#{value}'" }.compact
  sql_values = record.map { |key, value| dimension.columns[key].sql_value(value) }
%>
INSERT INTO <%= dimension.table_name %> (<%= record.keys.join(', ') %>)
SELECT <%= sql_values.join(', ') %>
WHERE NOT EXISTS (SELECT 1 FROM <%= dimension.table_name %> WHERE <%= unique_constraints.join('AND') %>);
<%- end -%>

<%- dimension.index_columns.each do |name, _| -%>
CREATE INDEX <%= dimension.table_name %>_<%= name %>_index ON <%= dimension.table_name %> (<%= name %>);
<%- end -%>

<%- dimension.functions.each do |_, function| -%>
<%= function %>
<%- end -%>
