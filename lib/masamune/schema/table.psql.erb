<% source_files ||= [] %>

<%- table.children.each do |child| -%>
<%= child.as_psql %>
<%- end -%>

<%- if table.temporary? -%>
CREATE TEMPORARY TABLE IF NOT EXISTS <%= table.name %>
<%- else -%>
CREATE TABLE IF NOT EXISTS <%= table.name %>
<%- end -%>
(
  <%- table.defined_columns.each do |column, last| -%>
  <%= column.as_psql %><%= ',' unless last && table.unique_columns.none? %>
  <%- end -%>
  <%- if table.unique_columns.any? -%>
  UNIQUE(<%= table.unique_columns.keys.join(', ') %>)
  <%- end -%>
);

<%- source_files.each do |source_file| -%>
COPY <%= table.name %> FROM '<%= source_file.path %>' WITH (FORMAT 'csv');
<%- end -%>

<%= render 'define_index.psql.erb', table: table %>

<% table.insert_rows.each do |row| %>
INSERT INTO <%= table.name %> (<%= row.insert_columns.join(', ') %>)
SELECT <%= row.insert_values.join(', ') %>
WHERE NOT EXISTS (SELECT 1 FROM <%= table.name %> WHERE <%= row.insert_constraints.join(' AND ') %>);
<%- end -%>

<% table.aliased_rows.each do |row| %>
<%- row.surrogate_keys.each do |column| -%>
CREATE OR REPLACE FUNCTION <%= row.name(column) %>
RETURNS <%= column.sql_type %> IMMUTABLE AS $$
  SELECT <%= row.values[column.name] %>;
$$ LANGUAGE SQL;
<%- end -%>

CREATE OR REPLACE FUNCTION <%= row.name %>
RETURNS <%= table.primary_key.sql_type %> IMMUTABLE AS $$
  SELECT <%= table.primary_key.name %> FROM <%= table.name %> WHERE <%= row.insert_constraints.join(' AND ') %>;
$$ LANGUAGE SQL;
<%- end -%>
