<%
  dimension_stage = dimension.stage_table
%>

<%= input.as_table %>

CREATE TEMPORARY TABLE IF NOT EXISTS <%= dimension_stage.table_name %> (LIKE <%= dimension.table_name %> INCLUDING ALL);

INSERT INTO
  <%= dimension_stage.table_name %> (<%= input.insert_columns(dimension).join(', ') %>)
SELECT
  <%- input.insert_values(dimension).each do |value, last| -%>
  <%= value %><%= ',' unless last %>
  <%- end -%>
FROM
  <%= input.table_name %>
;

<%= render 'bulk_upsert.psql.erb', target: dimension, source: dimension_stage %>
