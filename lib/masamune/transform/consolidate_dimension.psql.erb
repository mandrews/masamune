CREATE TEMPORARY TABLE IF NOT EXISTS <%= source.table_name %> (LIKE <%= target.table_name %> INCLUDING ALL);

<%#
Consolidate complete events from partial events
For discussion on range and group constructions, see:
http://www.postgresql.org/message-id/CAGnEbohhKmW55oB0FpQd3naXBkwi74E=8DRZBGFjS-MeGpXLaA@mail.gmail.com
-%>
WITH ranges AS (
  SELECT *,
  CASE WHEN delta = 0
  THEN 1 ELSE NULL END r
  FROM <%= target.ledger_table.table_name %>
), windows AS (
  SELECT *,
  SUM(r) OVER (ORDER BY <%= source.consolidated_window('start_at').join(', ') %>) window_id
  FROM ranges
)
INSERT INTO
  <%= source.table_name %> (<%= source.consolidated_columns.map { |_, column, _| column.name }.join(',') %>)
SELECT
  <%- source.consolidated_columns.each do |_, column, last| -%>
  consolidated.<%= column.name %><%= ',' unless last %>
  <%- end -%>
FROM (
  SELECT
    FIRST_VALUE(uuid) OVER w AS parent_uuid,
    FIRST_VALUE(start_at) OVER w AS parent_start_at,
    uuid AS record_uuid,
    <%- source.consolidated_values(window: 'w').each do |value, last| -%>
    <%= value %><%= ',' unless last %>
    <%- end -%>
  FROM
    windows
  WINDOW w AS (PARTITION BY <%= source.consolidated_window('window_id').join(', ') %> ORDER BY start_at)
) consolidated
WHERE
  <%- source.consolidated_constraints.each do |name, column| -%>
  consolidated.<%= column.name %> IS NOT NULL AND
  <%- end -%>
  <%-# Do not consider partial events that occur simultaneously with complete parent event -%>
  (
    parent_uuid = record_uuid OR
    parent_start_at <> start_at
  )
;
