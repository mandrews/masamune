BEGIN;
LOCK TABLE <%= target.table_name %> IN EXCLUSIVE MODE;

<%-# Relabel version column -%>
UPDATE <%= target.table_name %> SET version = NULL;

UPDATE
  <%= target.table_name %>
SET
  version = tmp.version
FROM
  (
    SELECT
      uuid,
      <%- target.consolidated_window.each do |name| -%>
      <%= name %>,
      <%- end -%>
      start_at,
      rank() OVER (PARTITION BY <%= target.consolidated_window.join(', ') %> ORDER BY start_at) AS version
    FROM
      <%= target.table_name %>
    GROUP BY
      <%= target.consolidated_window(:uuid, :start_at).join(', ') %>
   ) AS tmp
WHERE
  <%= target.table_name %>.uuid = tmp.uuid
;

<%-# Relabel end_at column -%>
UPDATE <%= target.table_name %> SET end_at = NULL;

UPDATE
  <%= target.table_name %>
SET
  end_at = tmp.end_at
FROM
  (
    SELECT
      uuid,
      start_at,
      <%- target.consolidated_window.each do |name| -%>
      <%= name %>,
      <%- end -%>
      LEAD(start_at, 1) OVER (PARTITION BY <%= target.consolidated_window.join(', ') %> ORDER BY start_at) AS end_at
    FROM
      <%= target.table_name %>
    GROUP BY
      <%= target.consolidated_window(:uuid, :start_at).join(', ') %>
   ) AS tmp
WHERE
  <%= target.table_name %>.uuid = tmp.uuid
;

COMMIT;
