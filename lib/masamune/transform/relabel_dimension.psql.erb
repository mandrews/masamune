BEGIN;
LOCK TABLE <%= target.name %> IN EXCLUSIVE MODE;

<%-# Relabel version column -%>
UPDATE <%= target.name %> SET version = NULL;

UPDATE
  <%= target.name %>
SET
  version = tmp.version
FROM
  (
    SELECT
      uuid,
      <%- target.window.each do |name| -%>
      <%= name %>,
      <%- end -%>
      start_at,
      rank() OVER (PARTITION BY <%= target.window.join(', ') %> ORDER BY start_at) AS version
    FROM
      <%= target.name %>
    GROUP BY
      <%= target.window(:uuid, :start_at).join(', ') %>
   ) AS tmp
WHERE
  <%= target.name %>.uuid = tmp.uuid
;

<%-# Relabel end_at column -%>
UPDATE <%= target.name %> SET end_at = NULL;

UPDATE
  <%= target.name %>
SET
  end_at = tmp.end_at
FROM
  (
    SELECT
      uuid,
      start_at,
      <%- target.window.each do |name| -%>
      <%= name %>,
      <%- end -%>
      LEAD(start_at, 1) OVER (PARTITION BY <%= target.window.join(', ') %> ORDER BY start_at) AS end_at
    FROM
      <%= target.name %>
    GROUP BY
      <%= target.window(:uuid, :start_at).join(', ') %>
   ) AS tmp
WHERE
  <%= target.name %>.uuid = tmp.uuid
;

COMMIT;
