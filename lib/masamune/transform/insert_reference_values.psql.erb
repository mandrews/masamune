CREATE TEMPORARY TABLE IF NOT EXISTS <%= target.stage_table.name %> (LIKE <%= target.name %> INCLUDING ALL);

INSERT INTO
  <%= target.stage_table.name %> (<%= target.insert_columns(source).join(', ') %>)
SELECT DISTINCT
  <%- target.insert_values(source).each do |value, last| -%>
  <%= value %><%= ',' unless last %>
  <%- end -%>
FROM
  <%= source.name %>
<%- if target.insert_constraints(source).any? -%>
WHERE
  <%- target.insert_constraints(source).each do |constraint, last| -%>
  <%= constraint %><%= ' AND' unless last %>
  <%- end -%>
<%- end -%>
;
